<% if @quote %>
  <%# === QUOTE CONTEXT === %>
  <%# Update payment history - replace entire section to handle first payment case %>
  <%= turbo_stream.replace "payment_history" do %>
    <div id="payment_history">
      <% if @quote.payments.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 print:divide-gray-300">
            <thead class="bg-gray-50 print:bg-transparent">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide print:text-black"><%= t('quotes.show.payments_headers.date') %></th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wide print:text-black"><%= t('quotes.show.payments_headers.amount') %></th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide print:text-black"><%= t('quotes.show.payments_headers.notes') %></th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wide print:hidden no-print"><%= t('global.actions.actions') %></th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200 print:divide-gray-300" id="payment_history_body">
              <% @quote.payments.order(date: :desc).each do |payment| %>
                <tr id="payment_<%= payment.id %>">
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 print:text-black">
                    <%= l(payment.date) %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900 text-right print:text-black">
                    $<%= number_with_precision(payment.amount, precision: 0) %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-700 print:text-black">
                    <%= payment.notes.presence || "â€”" %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-center print:hidden no-print">
                    <%= link_to edit_payment_path(payment), class: "text-indigo-600 hover:text-indigo-900", title: t('global.actions.edit') do %>
                      <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                      </svg>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm print:text-gray-700"><%= t('quotes.show.no_payments') %></p>
      <% end %>
    </div>
  <% end %>

  <%# Replace status badge %>
  <%= turbo_stream.replace "quote_status_badge" do %>
    <div class="md:text-right" id="quote_status_badge">
      <%= render "quotes/status_badge", quote: @quote %>
    </div>
  <% end %>

  <%# Replace payment summary (amount paid and due) %>
  <%= turbo_stream.replace "payment_summary" do %>
    <div class="mb-6" id="payment_summary">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700 print:text-black"><%= t('quotes.show.paid') %>:</span>
        <span class="text-lg font-semibold text-gray-900 print:text-black" id="amount_paid">$<%= number_with_precision(@quote.amount_paid, precision: 0) %></span>
      </div>
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700 print:text-black"><%= t('quotes.show.due') %>:</span>
        <span class="text-lg font-semibold text-gray-900 print:text-black" id="amount_due">$<%= number_with_precision(@quote.amount_due, precision: 0) %></span>
      </div>
    </div>
  <% end %>

<% elsif @client && @ledger_data %>
  <%# === CLIENT CONTEXT === %>

  <%# Update Client Balance KPI %>
  <% balance_value = @client.balance || 0 %>
  <% balance_class = balance_value < 0 ? "text-red-600" : balance_value == 0 ? "text-gray-900" : "text-green-600" %>
  <%= turbo_stream.replace "client_balance_value" do %>
    <p class="text-3xl font-bold <%= balance_class %>" id="client_balance_value">$<%= number_with_precision(balance_value, precision: 0) %></p>
  <% end %>

  <%# Update Total Collected KPI %>
  <%= turbo_stream.replace "client_collected_value" do %>
    <p class="text-3xl font-bold text-green-600" id="client_collected_value">$<%= number_with_precision(@ledger_data[:total_collected], precision: 0) %></p>
  <% end %>

  <%# Update Ledger Table %>
  <%= turbo_stream.update "client_ledger" do %>
    <%= render "clients/ledger_content",
        client: @client,
        ledger_items: @ledger_data[:ledger_items],
        previous_balance: @ledger_data[:previous_balance],
        filtering: @ledger_data[:filtering],
        start_date: @ledger_data[:start_date],
        end_date: @ledger_data[:end_date],
        pagination: @ledger_data[:pagination] %>
  <% end %>
<% end %>

<%# Close modal by removing turbo frame content %>
<%= turbo_stream.update "modal", "" %>

<%# Show flash message %>
<%= turbo_stream.append "flash_messages" do %>
  <div class="mb-4 rounded-lg border px-4 py-3 text-sm bg-green-50 border-green-200 text-green-800 flex items-center justify-between" 
       role="alert" 
       data-controller="flash"
       data-flash-target="message">
    <span><%= t('global.messages.payment_recorded') %></span>
    <button type="button" 
            class="ml-4 text-current opacity-70 hover:opacity-100 focus:outline-none"
            data-action="click->flash#dismiss"
            aria-label="Cerrar">
      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
<% end %>
